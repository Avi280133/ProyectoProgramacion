create table reserva (
idreserva int auto_increment primary key,
idservicio int not null,
idcliente char(8) not null,
fecha date not null,
hora time not null,
estado enum('pendiente', 'confirmada', 'cancelada') not null,
foreign key (idservicio) references servicio(idservicio) on delete cascade,
foreign key (idcliente) references cliente(idcliente) on delete cascade
);


CREATE TABLE IF NOT EXISTS reporte (
  idreporte INT AUTO_INCREMENT PRIMARY KEY,
  idservicio INT NOT NULL,
  idreportador CHAR(8) NOT NULL,
  motivo VARCHAR(150) NOT NULL,
  detalle VARCHAR(500) DEFAULT NULL,
  dia DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (idservicio) REFERENCES servicio(idservicio) ON DELETE CASCADE,
  FOREIGN KEY (idreportador) REFERENCES usuario(cedula) ON DELETE CASCADE
);

INSERT INTO servicio (titulo, ubicacion, precio, descripcion, imagen, categoria)
VALUES
('Diseño de páginas web', 'Montevideo', 25000, 'Creación de sitios web modernos y responsivos para negocios o emprendimientos.', 'imagenes/webdesign.jpg', 'Tecnología');



ALTER TABLE reporte DROP COLUMN motivo;
ALTER TABLE reporte DROP COLUMN detalle;

ALTER TABLE ofrece
CHANGE COLUMN dia tiempo DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
DROP COLUMN hora,
DROP PRIMARY KEY,
ADD PRIMARY KEY (idproveedor, idservicio, tiempo);

ALTER TABLE proveedor
MODIFY experiencia varchar(500) NULL, MODIFY habilidad varchar(200) NULL;

ALTER TABLE usuario
MODIFY COLUMN fotoperfil VARCHAR(255);

ALTER TABLE usuario
DROP COLUMN calle,
DROP COLUMN numeropuerta,
ADD COLUMN localidad VARCHAR(100);


select * from servicio;

CREATE TABLE IF NOT EXISTS notificacion (
  idnotificacion INT AUTO_INCREMENT PRIMARY KEY,
  idusuario CHAR(8) NOT NULL,                       -- receptor (proveedor, cliente o admin)
  tipo ENUM('reporte','solicitud','calificacion') NOT NULL,
  referencia INT DEFAULT NULL,                       -- id relacionado (idservicio, idreserva, idcalificacion...)
  mensaje VARCHAR(255) NOT NULL,
  leida TINYINT(1) NOT NULL DEFAULT 0,
  fecha DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (idusuario) REFERENCES usuario(cedula) ON DELETE CASCADE,
  INDEX (idusuario),
  INDEX (leida),
  INDEX (tipo)
);

CREATE TABLE IF NOT EXISTS calificacion (
  idcalificacion INT AUTO_INCREMENT PRIMARY KEY,
  idservicio INT NOT NULL,
  idcliente  CHAR(8) NOT NULL,
  puntaje    TINYINT NOT NULL CHECK (puntaje BETWEEN 1 AND 5),
  comentario VARCHAR(300) DEFAULT NULL,
  fecha DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (idservicio) REFERENCES servicio(idservicio) ON DELETE CASCADE,
  FOREIGN KEY (idcliente)  REFERENCES cliente(idcliente)   ON DELETE CASCADE
);

DROP TABLE IF EXISTS notificacion;

CREATE TABLE notificacion (
  idnotificacion INT AUTO_INCREMENT PRIMARY KEY,
  idusuario_receptor CHAR(8) NOT NULL,                    -- quién recibe (cliente, proveedor o admin)
  tipo ENUM('reporte','solicitud','calificacion') NOT NULL,
  referencia INT DEFAULT NULL,                            -- id del evento fuente (idreporte, idreserva, idcalificacion)
  actor CHAR(8) DEFAULT NULL,                             -- emisor (quién generó el evento)
  mensaje VARCHAR(255) NOT NULL,
  url VARCHAR(255) DEFAULT NULL,                          -- hacia dónde navegar en tu frontend
  leida TINYINT(1) NOT NULL DEFAULT 0,
  fecha DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (idusuario_receptor) REFERENCES usuario(cedula) ON DELETE CASCADE,
  INDEX (idusuario_receptor),
  INDEX (leida),
  INDEX (tipo),
  INDEX (fecha)
);


DELIMITER $$

DELIMITER //

DROP TRIGGER IF EXISTS trg_reserva_after_insert //
CREATE TRIGGER trg_reserva_after_insert
AFTER INSERT ON reserva
FOR EACH ROW
BEGIN
  DECLARE v_proveedor CHAR(8);

  SELECT o.idproveedor
    INTO v_proveedor
  FROM ofrece o
  WHERE o.idservicio = NEW.idservicio
  LIMIT 1;

  IF v_proveedor IS NOT NULL THEN
    INSERT INTO notificacion
      (idusuario_receptor, tipo, referencia, actor, mensaje, url)
    VALUES
      (v_proveedor,
       'solicitud',
       NEW.idreserva,
       NEW.idcliente,
       CONCAT('Nueva solicitud para el servicio #', NEW.idservicio,
              ' el ', DATE_FORMAT(NEW.fecha, '%d/%m/%Y'), ' a las ',
              DATE_FORMAT(NEW.hora, '%H:%i')),
       NULL);
  END IF;
END //

DELIMITER ;


DELIMITER //

DROP TRIGGER IF EXISTS trg_reporte_after_insert //
CREATE TRIGGER trg_reporte_after_insert
AFTER INSERT ON reporte
FOR EACH ROW
BEGIN
  DECLARE v_proveedor CHAR(8);

  SELECT o.idproveedor
    INTO v_proveedor
  FROM ofrece o
  WHERE o.idservicio = NEW.idservicio
  LIMIT 1;

  IF v_proveedor IS NOT NULL THEN
    INSERT INTO notificacion
      (idusuario_receptor, tipo, referencia, actor, mensaje, url)
    VALUES
      (v_proveedor,
       'reporte',
       NEW.idreporte,
       NEW.idreportador,
       CONCAT('Tu servicio #', NEW.idservicio, ' fue reportado.'),
       NULL);
  END IF;
END //

DELIMITER ;




DELIMITER //

DROP TRIGGER IF EXISTS trg_calificacion_after_insert //
CREATE TRIGGER trg_calificacion_after_insert
AFTER INSERT ON calificacion
FOR EACH ROW
BEGIN
  DECLARE v_proveedor CHAR(8);

  /* Dueño del servicio calificado */
  SELECT o.idproveedor
    INTO v_proveedor
  FROM ofrece o
  WHERE o.idservicio = NEW.idservicio
  LIMIT 1;

  IF v_proveedor IS NOT NULL THEN
    INSERT INTO notificacion
      (idusuario_receptor, tipo, referencia, actor, mensaje, url)
    VALUES
      (
        v_proveedor,
        'calificacion',
        NEW.idcalificacion,
        NEW.idcliente,
        CONCAT('Nuevo puntaje ', NEW.puntaje, '/5 en tu servicio #', NEW.idservicio,
               IF(NEW.comentario IS NULL OR NEW.comentario = '', '', CONCAT(': "', LEFT(NEW.comentario, 120), '"'))),
        'vistas-prov.php'
      );
  END IF;
END //

DELIMITER ;




INSERT INTO servicio (titulo, ubicacion, precio, descripcion, imagen, categoria)
VALUES ('Servicio de Prueba para Notificaciones', 'Montevideo', 1234.00,
        'Servicio creado para probar triggers de notificaciones.',
        'serv_demo.jpg', 'Tecnología');

SET @svc_id = LAST_INSERT_ID();

-- Vincular servicio con el proveedor en OFRECE
-- (usa columna 'tiempo' DATETIME según tu esquema final)
INSERT INTO ofrece (idservicio, idproveedor, tiempo)
VALUES (@svc_id, '12345679', NOW());

INSERT INTO usuario (cedula, nombre, apellido, username, email, contrasena, fotoperfil, edad, localidad)
VALUES ('11111111', 'Cliente', 'Demo', 'cli_demo', 'cli@example.com', 'x', 'cli.jpg', 28, 'Montevideo')
ON DUPLICATE KEY UPDATE
  username = VALUES(username),
  email    = VALUES(email),
  edad     = VALUES(edad),
  localidad= VALUES(localidad);

INSERT INTO cliente (idcliente)
VALUES ('11111111')
ON DUPLICATE KEY UPDATE idcliente = VALUES(idcliente);



INSERT INTO servicio (titulo, ubicacion, precio, descripcion, imagen, categoria)
VALUES ('Servicio de Prueba para Notificaciones', 'Montevideo', 1234.00,
        'Servicio creado para probar triggers de notificaciones.',
        'serv_demo.jpg', 'Tecnología');

SET @svc_id = LAST_INSERT_ID();

-- Vincular servicio con el proveedor en OFRECE
-- (usa columna 'tiempo' DATETIME según tu esquema final)
INSERT INTO ofrece (idservicio, idproveedor, tiempo)
VALUES (@svc_id, '12345679', NOW());



-- 3.1) SOLICITUD (reserva) -> debe crear notificación tipo 'solicitud' al proveedor 12345679
INSERT INTO reserva (idservicio, idcliente, fecha, hora, estado)
VALUES (@svc_id, '11111111', CURDATE() + INTERVAL 2 DAY, '15:00:00', 'pendiente');

-- 3.2) REPORTE -> debe crear notificación tipo 'reporte' al proveedor 12345679
-- (tu versión final de 'reporte' no tiene motivo/detalle)
INSERT INTO reporte (idservicio, idreportador)
VALUES (@svc_id, '11111111');

-- 3.3) CALIFICACION -> debe crear notificación tipo 'calificacion' al proveedor 12345679
INSERT INTO calificacion (idservicio, idcliente, puntaje, comentario)
VALUES (@svc_id, '11111111', 5, 'Excelente servicio, súper recomendable.');


SELECT idnotificacion, tipo, referencia, actor, mensaje, url, leida, fecha
FROM notificacion
WHERE idusuario_receptor = '12345679'
ORDER BY fecha DESC;

-- Para confirmar los IDs de los eventos fuente:
SELECT * FROM reserva     WHERE idservicio = @svc_id ORDER BY idreserva DESC LIMIT 3;
SELECT * FROM reporte     WHERE idservicio = @svc_id ORDER BY idreporte DESC LIMIT 3;
SELECT * FROM calificacion WHERE idservicio = @svc_id ORDER BY idcalificacion DESC LIMIT 3;

select * from usuario;

