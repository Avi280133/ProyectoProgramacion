DROP DATABASE IF EXISTS SkillMatch;
CREATE DATABASE SkillMatch CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE SkillMatch;

CREATE TABLE usuario (
    cedula      CHAR(8)     PRIMARY KEY,
    nombre      VARCHAR(50)  NOT NULL,
    apellido    VARCHAR(50)  NOT NULL,
    username    VARCHAR(50)  NOT NULL UNIQUE,
    email       VARCHAR(100) NOT NULL UNIQUE,
    contrasena  VARCHAR(100) NOT NULL,
    fotoperfil  VARCHAR(255),
    edad        INT CHECK (edad >= 18),
    localidad   VARCHAR(100)
) ENGINE=InnoDB;

CREATE TABLE administrador (
    idadministrador CHAR(8) PRIMARY KEY,
    FOREIGN KEY (idadministrador) REFERENCES usuario(cedula)
      ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

CREATE TABLE cliente (
    idcliente CHAR(8) PRIMARY KEY,
    FOREIGN KEY (idcliente) REFERENCES usuario(cedula)
      ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

CREATE TABLE proveedor (
    idproveedor CHAR(8) PRIMARY KEY,
    experiencia VARCHAR(500) NULL,
    habilidad   VARCHAR(200) NULL,
    FOREIGN KEY (idproveedor) REFERENCES usuario(cedula)
      ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

CREATE TABLE servicio (
    idservicio   INT AUTO_INCREMENT PRIMARY KEY,
    titulo       VARCHAR(100) NOT NULL,
    ubicacion    VARCHAR(100),
    precio       FLOAT CHECK (precio >= 0),
    descripcion  VARCHAR(300) NOT NULL,
    imagen       VARCHAR(255),
    categoria    VARCHAR(30),
    idproveedor  CHAR(8),
    FOREIGN KEY (idproveedor)
      REFERENCES proveedor(idproveedor)
      ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

CREATE TABLE categoria (
    idcategoria INT AUTO_INCREMENT PRIMARY KEY,
    nombre      VARCHAR(30)
) ENGINE=InnoDB;

CREATE TABLE ofrece (
    idservicio   INT      NOT NULL,
    idproveedor  CHAR(8)  NOT NULL,
    tiempo       DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (idproveedor, idservicio, tiempo),
    FOREIGN KEY (idproveedor) REFERENCES usuario(cedula)
      ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (idservicio)  REFERENCES servicio(idservicio)
      ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

CREATE TABLE mensaje (
    idemisor   CHAR(8)   NOT NULL,
    idreceptor CHAR(8)   NOT NULL,
    contenido  VARCHAR(200) NOT NULL,
    tiempo     DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (idemisor, idreceptor, tiempo),
    FOREIGN KEY (idemisor)   REFERENCES usuario(cedula)
      ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (idreceptor) REFERENCES usuario(cedula)
      ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

CREATE TABLE contrata (
    idcliente  CHAR(8)   NOT NULL,
    idservicio INT       NOT NULL,
    tiempo     DATETIME  NOT NULL DEFAULT CURRENT_TIMESTAMP,
    puntaje    INT CHECK (puntaje BETWEEN 1 AND 5),
    comentario VARCHAR(300),
    PRIMARY KEY (idcliente, idservicio, tiempo),
    FOREIGN KEY (idcliente)  REFERENCES cliente(idcliente)
      ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (idservicio) REFERENCES servicio(idservicio)
      ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

CREATE TABLE comenta (
    idproveedor CHAR(8)   NOT NULL,
    idservicio  INT       NOT NULL,
    idcliente   CHAR(8)   NOT NULL,
    contenido   VARCHAR(200) NOT NULL,
    dia         DATE      NOT NULL,
    hora        TIME      NOT NULL,
    PRIMARY KEY (idproveedor, idservicio, idcliente),
    FOREIGN KEY (idproveedor) REFERENCES proveedor(idproveedor)
      ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (idservicio)  REFERENCES servicio(idservicio)
      ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (idcliente)   REFERENCES cliente(idcliente)
      ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

CREATE TABLE reserva (
    idreserva   INT AUTO_INCREMENT PRIMARY KEY,
    idservicio  INT      NOT NULL,
    idcliente   CHAR(8)  NOT NULL,
    fecha       DATE     NOT NULL,
    hora        TIME     NOT NULL,
    estado      ENUM('pendiente','confirmada','cancelada') NOT NULL DEFAULT 'pendiente',
    FOREIGN KEY (idservicio) REFERENCES servicio(idservicio) ON DELETE CASCADE,
    FOREIGN KEY (idcliente)  REFERENCES cliente(idcliente)  ON DELETE CASCADE
) ENGINE=InnoDB;

CREATE TABLE gestiona (
    idadministrador CHAR(8) NOT NULL,
    idproveedor     CHAR(8) NOT NULL,
    idservicio      INT     NOT NULL,
    PRIMARY KEY (idadministrador, idproveedor, idservicio),
    FOREIGN KEY (idadministrador) REFERENCES administrador(idadministrador)
      ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (idproveedor)     REFERENCES proveedor(idproveedor)
      ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (idservicio)      REFERENCES servicio(idservicio)
      ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

CREATE TABLE supervisa (
    idadministrador CHAR(8) NOT NULL,
    cedula          CHAR(8) NOT NULL,
    PRIMARY KEY (idadministrador, cedula),
    FOREIGN KEY (idadministrador) REFERENCES administrador(idadministrador)
      ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (cedula)          REFERENCES usuario(cedula)
      ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

CREATE TABLE imagen (
    idimagen   INT AUTO_INCREMENT PRIMARY KEY,
    idservicio INT   NOT NULL,
    imagen     BLOB  NOT NULL,
    FOREIGN KEY (idservicio) REFERENCES servicio(idservicio)
      ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB;

CREATE TABLE reporte (
    idreporte     INT AUTO_INCREMENT PRIMARY KEY,
    idservicio    INT     NOT NULL,
    idreportador  CHAR(8) NOT NULL,
    dia           DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (idservicio)    REFERENCES servicio(idservicio) ON DELETE CASCADE,
    FOREIGN KEY (idreportador)  REFERENCES usuario(cedula)      ON DELETE CASCADE
) ENGINE=InnoDB;

CREATE TABLE calificacion (
    idcalificacion INT AUTO_INCREMENT PRIMARY KEY,
    idservicio     INT     NOT NULL,
    idcliente      CHAR(8) NOT NULL,
    puntaje        TINYINT NOT NULL CHECK (puntaje BETWEEN 1 AND 5),
    comentario     VARCHAR(300) DEFAULT NULL,
    fecha          DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (idservicio) REFERENCES servicio(idservicio) ON DELETE CASCADE,
    FOREIGN KEY (idcliente)  REFERENCES cliente(idcliente)   ON DELETE CASCADE
) ENGINE=InnoDB;

CREATE TABLE notificacion (
    idnotificacion       INT AUTO_INCREMENT PRIMARY KEY,
    idusuario_receptor   CHAR(8) NOT NULL,
    tipo                 ENUM('reporte','solicitud','calificacion') NOT NULL,
    referencia           INT DEFAULT NULL,
    actor                CHAR(8) DEFAULT NULL,
    mensaje              VARCHAR(255) NOT NULL,
    url                  VARCHAR(255) DEFAULT NULL,
    leida                TINYINT(1) NOT NULL DEFAULT 0,
    fecha                DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (idusuario_receptor) REFERENCES usuario(cedula) ON DELETE CASCADE,
    INDEX (idusuario_receptor),
    INDEX (leida),
    INDEX (tipo),
    INDEX (fecha)
) ENGINE=InnoDB;

-- TRIGGERS DE NOTIFICACIÃ“N
DELIMITER //

DROP TRIGGER IF EXISTS trg_reserva_after_insert //
DROP TRIGGER IF EXISTS trg_reporte_after_insert //
DROP TRIGGER IF EXISTS trg_calificacion_after_insert //

CREATE TRIGGER trg_reserva_after_insert
AFTER INSERT ON reserva
FOR EACH ROW
BEGIN
  DECLARE v_proveedor CHAR(8);
  SELECT o.idproveedor INTO v_proveedor
  FROM ofrece o
  WHERE o.idservicio = NEW.idservicio
  ORDER BY o.tiempo DESC
  LIMIT 1;
  IF v_proveedor IS NOT NULL THEN
    INSERT INTO notificacion
      (idusuario_receptor, tipo, referencia, actor, mensaje, url)
    VALUES
      (
        v_proveedor,
        'solicitud',
        NEW.idreserva,
        NEW.idcliente,
        CONCAT('Nueva solicitud para el servicio #', NEW.idservicio,
               ' el ', DATE_FORMAT(NEW.fecha, '%d/%m/%Y'), ' a las ',
               DATE_FORMAT(NEW.hora, '%H:%i')),
        NULL
      );
  END IF;
END //

CREATE TRIGGER trg_reporte_after_insert
AFTER INSERT ON reporte
FOR EACH ROW
BEGIN
  DECLARE v_proveedor CHAR(8);
  SELECT o.idproveedor INTO v_proveedor
  FROM ofrece o
  WHERE o.idservicio = NEW.idservicio
  ORDER BY o.tiempo DESC
  LIMIT 1;
  IF v_proveedor IS NOT NULL THEN
    INSERT INTO notificacion
      (idusuario_receptor, tipo, referencia, actor, mensaje, url)
    VALUES
      (
        v_proveedor,
        'reporte',
        NEW.idreporte,
        NEW.idreportador,
        CONCAT('Tu servicio #', NEW.idservicio, ' fue reportado.'),
        NULL
      );
  END IF;
END //

CREATE TRIGGER trg_calificacion_after_insert
AFTER INSERT ON calificacion
FOR EACH ROW
BEGIN
  DECLARE v_proveedor CHAR(8);
  SELECT o.idproveedor INTO v_proveedor
  FROM ofrece o
  WHERE o.idservicio = NEW.idservicio
  ORDER BY o.tiempo DESC
  LIMIT 1;
  IF v_proveedor IS NOT NULL THEN
    INSERT INTO notificacion
      (idusuario_receptor, tipo, referencia, actor, mensaje, url)
    VALUES
      (
        v_proveedor,
        'calificacion',
        NEW.idcalificacion,
        NEW.idcliente,
        CONCAT(
          'Nuevo puntaje ', NEW.puntaje, '/5 en tu servicio #', NEW.idservicio,
          IF(NEW.comentario IS NULL OR NEW.comentario = '', '',
             CONCAT(': "', LEFT(NEW.comentario, 120), '"'))
        ),
        'vistas-prov.php'
      );
  END IF;
END //

DELIMITER ;
